<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<app:handleError>
    <zm:getMailbox var="mailbox"/>
    <c:choose>
    <c:when test="${mailbox.prefs.locale}">
        <fmt:setLocale value='${mailbox.prefs.locale}' scope='request' />
    </c:when>
    <c:otherwise>
        <fmt:setLocale value='${pageContext.request.locale}' scope='request' />
    </c:otherwise>
    </c:choose>
    <fmt:setBundle basename="/messages/ZhMsg" scope="session"/>
    <app:composeCheck/>
    <c:set var="action" value="${empty param.paction ? param.action : param.paction}" scope="request"/>
    <jsp:useBean id="expanded" scope="session" class="java.util.HashMap" />

     <c:if test="${not empty param.expand}">
         <c:set target="${sessionScope.expanded}" property="${param.expand}" value="expand"/>
     </c:if>
     <c:if test="${not empty param.collapse}">
         <c:set target="${sessionScope.expanded}" property="${param.collapse}" value="collapse"/>
     </c:if>
    <c:if test="${param.initial eq 'true'}">
        <c:if test="${mailbox.features.portalEnabled}">
            <c:redirect url="home?mesg=welcome"/>
        </c:if>
    </c:if>
     <%-- switch based on context search types --%>
     <c:choose>
         <c:when test="${not empty param.doConvListViewAction}">
             <app:convListViewAction/>
         </c:when>
         <c:when test="${not empty param.doMessageAction}">
             <app:messageAction/>
         </c:when>
         <c:when test="${param.action eq 'newtask' or param.action eq 'edittask'}">
             <app:editTaskCheck/>
         </c:when>
         <c:when test="${not empty param.doTaskAction}">
             <app:taskAction/>
         </c:when>
         <c:when test="${not empty param.doContactListViewAction or param.action eq 'newcontact' or param.action eq 'newcontactgroup'}">
             <app:contactListViewAction/>
         </c:when>
         <c:when test="${not empty param.doVoiceMailListViewAction}">
             <app:voiceMailListViewAction/>
         </c:when>
     </c:choose>

    <c:if test="${param.st eq 'appointment'}">
        <c:redirect url="/h/calendar">
            <c:param name="sq" value="${param.sq}"/>
        </c:redirect>
    </c:if>

    <c:if test="${not mailbox.features.mail}">
        <c:if test="${param.st eq 'message' or param.st eq 'conversation' or empty param.st}">
            <c:redirect url="/h/calendar"/>
        </c:if>
    </c:if>

    <zm:computeSearchContext var="context" usecache="true"/>

</app:handleError>
<c:if test="${param.mesg eq 'welcome'}">
    <app:status style="info" html="true">
        <fmt:message key="htmlWelcomeMesg"/>
    </app:status>
</c:if>
 <%-- switch based on context search types --%>
<c:choose>
    <c:when test="${context.isConversationSearch and action eq 'view'}">
        <app:convView context="${context}"/>
    </c:when>
    <c:when test="${context.isConversationSearch and action eq 'view2'}">
        <app:convView2 context="${context}"/>
    </c:when>
    <c:when test="${context.isConversationSearch and param.print}">
        <app:convPrintView context="${context}"/>
    </c:when>
    <c:when test="${context.isConversationSearch}">
        <app:convListView context="${context}"/>
    </c:when>
    <c:when test="${context.isMessageSearch and action eq 'view'}">
        <app:messageView context="${context}"/>
    </c:when>
    <c:when test="${context.isMessageSearch}">
        <app:messageListView context="${context}"/>
    </c:when>
    <c:when test="${context.isContactSearch and action eq 'view'}">
        <app:contactView context="${context}"/>
    </c:when>
    <c:when test="${context.isContactSearch}">
        <app:contactListView context="${context}"/>
    </c:when>
    <c:when test="${context.isTaskSearch}">
        <app:taskListView context="${context}"/>
    </c:when>
    <c:when test="${context.isVoiceMailSearch}">
        <app:voiceMailListView context="${context}"/>
    </c:when>
    <c:when test="${context.isCallSearch}">
        <app:callListView context="${context}"/>
    </c:when>
    <c:otherwise>
        <fmt:message key="error" var="title"/>
        <app:view mailbox="${mailbox}" title="${title}" selected="${not mailbox.features.mail ? 'calendar' : 'mail'}" context="${context}" folders="true" tags="true" searches="true" ads="" keys="true">
            <fmt:message key="ztaglib.TAG_EXCEPTION"/>
        </app:view>
    </c:otherwise>
</c:choose>
