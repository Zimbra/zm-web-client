<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<fmt:setBundle basename="/msgs/ZhMsg" scope="session"/>

<app:handleError>
    <c:if test="${!empty param.doAction}">
        <app:tagAction/>
    </c:if>
    <zm:getMailbox var="mailbox"/>

    <c:choose>
        <c:when test="${not empty requestScope.newlyCreatedTagName}">
             <zm:forEachTag var="tag">
                <c:if test="${requestScope.newlyCreatedTagName eq tag.name}"><c:set var="selectedTag" value="${tag}"/></c:if>
            </zm:forEachTag>
        </c:when>
        <c:when test="${not empty param.id}">
            <c:set var="selectedTag" value="${zm:getTag(pageContext, param.id)}"/>
        </c:when>
        <c:when test="${not empty param.sti}">
            <c:set var="selectedTag" value="${zm:getTag(pageContext, param.sti)}"/>            
        </c:when>
    </c:choose>

    <c:set var="newTag" value="${zm:actionSet(param, 'actionNewTag')}"/>

    <c:if test="${empty selectedTag and not newTag}">
        <zm:forEachTag var="tag">
            <c:if test="${empty selectedTag}">
                <c:set var="selectedTag" value="${tag}"/>
            </c:if>
        </zm:forEachTag>
    </c:if>

    <c:set var="toolbar">
        <table width=100% cellspacing=0>
            <tr>
                <td>
                    <table cellspacing=2 cellpadding=0 class='Tb'>
                        <tr>
                            <app:button name="actionNewTag" src="tag/NewTag.gif" tooltip="tagNew" text="tagNew"/>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </c:set>
    <fmt:message var="title" key="manageTags"/>

</app:handleError>

<app:view title="${title}" context="${null}" selected='folders' tags="true" editmode="true" keys="true">

    <form action="" method="post">
        <table width=100% cellspacing="0" cellpadding="0">
            <tr>
                <td class='TbTop'>
                    <table cellspacing=0 class='Tb'>
                        <tr>
                            <td></td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td class='ZhAppContent'>
                    <table border="0" cellpadding="0" cellspacing="0" width=100%>
                        <tr>
                            <td colspan=2 class='ZhSubTabs'>
                                <app:foldersTabs mailbox="${mailbox}" selected='tags'/>
                            </td>
                        </tr>
                        <tr>
                            <td colspan=2 class='TbBottom'>${toolbar}</td>
                        </tr>
                        <tr>
                            <td width=200 class='List' valign='top'>
                                <table width=100% cellpadding=2 cellspacing=0>
                                    <zm:forEachTag var="tag">
                                        <c:set var="hasTags" value="${true}"/>
                                        <tr <c:if test="${selectedTag.id eq tag.id and not newTag}">class='RowSelected'</c:if>>
                                            <td width=1%>
                                                &nbsp;
                                            </td>
                                            <td>
                                                <c:url var="selectUrl" value="">
                                                    <c:param name="id" value="${tag.id}"/>
                                                </c:url>
                                                <a href="${selectUrl}">
                                                    <app:img src="${tag.image}"/>
                                                        <span style='vertical-align:middle;'>${fn:escapeXml(tag.name)}</span>
                                                </a>
                                            </td>
                                        </tr>
                                    </zm:forEachTag>
                                    <c:if test="${not hasTags}">
                                        <tr>
                                            <td>
                                                <div class='NoResults'>
                                                    <fmt:message key="tagNoTags"/>
                                                </div>
                                            </td>
                                        </tr>
                                    </c:if>
                                </table>
                            </td>
                            <td class='ZhEditTagContent' valign='top'>
                                <c:choose>
                                    <c:when test="${zm:actionSet(param, 'actionNewTag')}">
                                        <app:newTag/>
                                    </c:when>
                                    <c:when test="${not empty selectedTag}">
                                        <app:editTag tag="${selectedTag}"/>
                                    </c:when>
                                    <c:otherwise>
                                        &nbsp;
                                    </c:otherwise>
                                </c:choose>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>

        </table>
        <input type="hidden" name="doAction" value="1"/>
    </form>
</app:view>
