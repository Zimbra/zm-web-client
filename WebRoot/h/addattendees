<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<app:handleError>
    <zm:getMailbox var="mailbox"/>
        <c:choose>
        <c:when test="${not empty mailbox.prefs.locale}">
            <fmt:setLocale value='${mailbox.prefs.locale}' scope='request' />
        </c:when>
        <c:otherwise>
            <fmt:setLocale value='${pageContext.request.locale}' scope='request' />
        </c:otherwise>
        </c:choose>
        <fmt:setBundle basename="/messages/ZhMsg" scope="session"/>
    
    <fmt:message var="title" key="addAttendeesFromContacts"/>

    <zm:composeUploader var="uploader"/>
    <c:set var="compose" value="${uploader.compose}"/>

    <c:choose>
        <c:when test="${uploader.isContactSearch}">
            <c:choose>
                <c:when test="${uploader.contactLocation eq 'gal'}">
                    <zm:searchGal var="searchGal" query="${uploader.contactSearchQuery}" type="account"/>
                </c:when>
                <c:otherwise>
                    <zm:search var="search" query="${uploader.contactSearchQuery}" sort="nameAsc" types="contact" field="contact:"/>
                </c:otherwise>
            </c:choose>
            <c:set var="query" value="${uploader.contactSearchQuery}"/>
        </c:when>
        <c:otherwise>
            <c:set var="query" value=""/>
        </c:otherwise>
    </c:choose>
</app:handleError>

<app:view mailbox="${mailbox}" title="${title}" selected='compose' folders="true" tags="true" searches="true" context="${null}" keys="false"
    onload="var e=document.getElementById('findField'); if (e) e.focus();">

<c:set var="toolbar">
    <table width=100% cellspacing=0>
        <tr valign='middle'>
            <td class='TbBt'>
                <table cellspacing=0 cellpadding=0 class='Tb'>
                    <tr>
                        <app:button name="actionContactDone" src="common/ImgCheck.gif" tooltip="done" text="done"/>
                        <td><div class='vertSep'></div></td>
                        <app:button name="actionContactAdd" src="contacts/ImgContactsPicker.gif" tooltip="addSelected" text="addSelected"/>
                        <td><div class='vertSep'></div></td>
                        <app:button name="actionContactCancel" src="common/ImgCancel.gif" tooltip="cancel" text="cancel"/>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</c:set>
<SCRIPT TYPE="text/javascript">
<!--
var checkEnter = function(f,e) {var k; if (window.event) k = window.event.keyCode; else if (e) k = e.which; else return true;
if (k == 13) { document.getElementById("doSearch").click();return false;} else {return true;}}
//-->
</SCRIPT>
<form action="" method="post" enctype="multipart/form-data" accept-charset="utf-8">
<table width=100% cellpadding="0" cellspacing="0">
    <tr>
        <td class='TbTop'>
                ${toolbar}
        </td>
    </tr>
    <tr>
        <td class='ZhAppContent'>
            <table width=100% cellpadding="0" cellspacing="10">
                <c:if test="${not (empty compose.attendees and empty uploader.pendingAttendees)}">
                    <tr>
                        <td class=MsgHdr>
                            <table width=100% cellpadding=2 cellspacing=0 border=0>
                                <tr>
                                    <td class='MsgHdrName'>
                                        <fmt:message key="attendees"/>
                                        :
                                    </td>
                                    <td class='MsgHdrValue'>
                                        <c:out value="${compose.attendees}"/>
                                        <c:if test="${not empty uploader.pendingAttendees}">
                                <span style='font-weight:bold'>
                                    <c:if test="${not empty compose.attendees and not fn:endsWith(fn:trim(compose.attendees),',')}">
                                        ,
                                    </c:if>
                                    <c:out value="${uploader.pendingAttendees}"/>
                                </span>
                                        </c:if>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </c:if>
                <tr>
                    <td class='SearchBar'>
                        &nbsp;
                        <label for="findField"><fmt:message key="find"/>
                        :</label>
                        <input id="findField" class="searchField" style='width:50%' maxlength=2048 name='contactSearchQuery'
                               value="${fn:escapeXml(query)}" onkeypress="return checkEnter(this,event)">
                        &nbsp;
                        <fmt:message key="in"/>
                        &nbsp;
                        <select name="contactLocation">
                            <c:if test="${mailbox.features.contacts}">
                                <option
                                        <c:if test="${empty uploader.contactLocation or uploader.contactLocation eq 'personal'}">
                                            selected
                                        </c:if> value="contact"/>
                                <fmt:message key="searchPersonalContacts"/>
                            </c:if>
                            <c:if test="${mailbox.features.gal}">
                                <option
                                        <c:if test="${uploader.contactLocation eq 'gal'}">selected</c:if> value="gal"/>
                                <fmt:message key="GAL"/>
                            </c:if>
                        </select>
                        <input id="doSearch" class="SearchButton" type=submit name='actionContactSearch'
                               value="<fmt:message key="searchContacts"/>">
                    </td>
                </tr>
                <tr>
                    <td class='List'>
                        <app:contactAddListView attendeeMode="${true}" searchResult="${search}" searchGalResult="${searchGal}"/>
                    </td>
                </tr>
            </table>

        </td>
    </tr>
    <tr>
        <td class='TbBottom'>
                ${toolbar}
        </td>
    </tr>
</table>

    <input type="hidden" name="apptFolderId" value="${fn:escapeXml(compose.apptFolderId)}"/>
    <input type="hidden" name="classProp" value="${fn:escapeXml(compose.classProp)}"/>
    <input type="hidden" name="invId" value="${fn:escapeXml(compose.inviteId)}"/>
    <input type="hidden" name="exInvId" value="${fn:escapeXml(compose.exceptionInviteId)}"/>
    <input type="hidden" name="useInstance" value="${fn:escapeXml(compose.useInstance ? '1' : '0') }"/>
    <input type="hidden" name="instStartTime" value="${fn:escapeXml(compose.instanceStartTime)}"/>
    <input type="hidden" name="instDuration" value="${fn:escapeXml(compose.instanceDuration)}"/>
    <input type="hidden" name="subject" value="${fn:escapeXml(compose.subject)}"/>
    <input type="hidden" name="location" value="${fn:escapeXml(compose.location)}"/>
    <input type="hidden" name="freeBusyStatus" value="${fn:escapeXml(compose.freeBusyStatus)}"/>
    <input type="hidden" name="allDay" value="${fn:escapeXml(compose.allDay ? '1':'0')}"/>
    <input type="hidden" name="startDate" value="${fn:escapeXml(compose.startDate)}"/>
    <input type="hidden" name="startHour" value="${fn:escapeXml(compose.startHour)}"/>
    <input type="hidden" name="startMinute" value="${fn:escapeXml(compose.startMinute)}"/>
    <input type="hidden" name="endDate" value="${fn:escapeXml(compose.endDate)}"/>
    <input type="hidden" name="endHour" value="${fn:escapeXml(compose.endHour)}"/>
    <input type="hidden" name="endMinute" value="${fn:escapeXml(compose.endMinute)}"/>
    <input type="hidden" name="timeZone" value="${fn:escapeXml(compose.timeZone)}"/>
    <input type="hidden" name="attendees" value="${fn:escapeXml(compose.attendees)}"/>
    <input type="hidden" name="body" value="${fn:escapeXml(compose.content)}"/>
    <c:forEach var="ma" items="${compose.messageAttachments}">
        <input type="hidden" name="messageAttachment" value="${ma.id}:${fn:escapeXml(ma.subject)}"/>
    </c:forEach>
    <c:forEach var="ca" items="${compose.checkedAttachmentNames}">
        <input type="hidden" name="originalAttachment" value="${fn:escapeXml(ca.key)}"/>
    </c:forEach>
    <input type="hidden" name="pendingAttendees" value="${fn:escapeXml(uploader.pendingAttendees)}"/>

        <input type="hidden" name="repeatBasicType" value="${fn:escapeXml(compose.repeatBasicType)}"/>
       <input type="hidden" name="repeatType" value="${fn:escapeXml(compose.repeatType)}"/>
        <input type="hidden" name="repeatDailyInterval" value="${fn:escapeXml(compose.repeatDailyInterval)}"/>
        <input type="hidden" name="repeatWeeklyByDay" value="${fn:escapeXml(compose.repeatWeeklyByDay)}"/>
        <input type="hidden" name="repeatWeeklyInterval" value="${fn:escapeXml(compose.repeatWeeklyInterval)}"/>
        <input type="hidden" name="repeatWeeklySun" value="${fn:escapeXml(compose.repeatWeeklySun) ? '1' : '0'}"/>
        <input type="hidden" name="repeatWeeklyMon" value="${fn:escapeXml(compose.repeatWeeklyMon) ? '1' : '0'}"/>
        <input type="hidden" name="repeatWeeklyTue" value="${fn:escapeXml(compose.repeatWeeklyTue) ? '1' : '0'}"/>
        <input type="hidden" name="repeatWeeklyWed" value="${fn:escapeXml(compose.repeatWeeklyWed) ? '1' : '0'}"/>
        <input type="hidden" name="repeatWeeklyThu" value="${fn:escapeXml(compose.repeatWeeklyThu) ? '1' : '0'}"/>
        <input type="hidden" name="repeatWeeklyFri" value="${fn:escapeXml(compose.repeatWeeklyFri) ? '1' : '0'}"/>
        <input type="hidden" name="repeatWeeklySat" value="${fn:escapeXml(compose.repeatWeeklySat) ? '1' : '0'}"/>
        <input type="hidden" name="repeatMonthlyInterval" value="${fn:escapeXml(compose.repeatMonthlyInterval)}"/>
        <input type="hidden" name="repeatMonthlyMonthDay" value="${fn:escapeXml(compose.repeatMonthlyMonthDay)}"/>
        <input type="hidden" name="repeatMonthlyRelativeInterval" value="${fn:escapeXml(compose.repeatMonthlyRelativeInterval)}"/>
        <input type="hidden" name="repeatMonthlyRelativeOrd" value="${fn:escapeXml(compose.repeatMonthlyRelativeOrd)}"/>
        <input type="hidden" name="repeatMonthlyRelativeDay" value="${fn:escapeXml(compose.repeatMonthlyRelativeDay)}"/>
        <input type="hidden" name="repeatYearlyMonthDay" value="${fn:escapeXml(compose.repeatYearlyMonthDay)}"/>
        <input type="hidden" name="repeatYearlyMonth" value="${fn:escapeXml(compose.repeatYearlyMonth)}"/>
        <input type="hidden" name="repeatYearlyRelativeOrd" value="${fn:escapeXml(compose.repeatYearlyRelativeOrd)}"/>
        <input type="hidden" name="repeatYearlyRelativeDay" value="${fn:escapeXml(compose.repeatYearlyRelativeDay)}"/>
        <input type="hidden" name="repeatYearlyRelativeMonth" value="${fn:escapeXml(compose.repeatYearlyRelativeMonth)}"/>
        <input type="hidden" name="repeatEndType" value="${fn:escapeXml(compose.repeatEndType)}"/>
        <input type="hidden" name="repeatEndCount" value="${fn:escapeXml(compose.repeatEndCount)}"/>
        <input type="hidden" name="repeatEndDate" value="${fn:escapeXml(compose.repeatEndDate)}"/>
        <input type="hidden" name="crumb" value="${fn:escapeXml(mailbox.accountInfo.crumb)}"/>
</form>
</app:view>
